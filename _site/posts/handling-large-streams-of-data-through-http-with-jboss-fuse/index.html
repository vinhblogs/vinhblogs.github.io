<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <link rel="shortcut icon" type="image/png" href="/icon.png" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@koint">
  <meta name="twitter:creator" content="@koint">

  <!-- SEO stuff -->
  <title>Handling Large Streams of Data through HTTP with JBoss Fuse</title>
  <meta property="og:title" content="Handling Large Streams of Data through HTTP with JBoss Fuse" />
  <meta name="twitter:title" content="Handling Large Streams of Data through HTTP with JBoss Fuse">


  
	  <meta name="description" content="Service and api platforms are mostly real time oriented and handle small amounts of data that can be easily processed in memory.
But for many legacy purposes and for content management systems, being able
to handle large sets of data is a very common requirement.
This article shows how to easily send and receive large data files through HTTP with JBoss Fuse using streams.
The main objective of being able to use streams is to avoid running into out of memory issues." />
	  <meta property="og:description" content="Service and api platforms are mostly real time oriented and handle small amounts of data that can be easily processed in memory.
But for many legacy purposes and for content management systems, being able
to handle large sets of data is a very common requirement.
This article shows how to easily send and receive large data files through HTTP with JBoss Fuse using streams.
The main objective of being able to use streams is to avoid running into out of memory issues." />
	  <meta name="twitter:description" content="Service and api platforms are mostly real time oriented and handle small amounts of data that can be easily processed in memory.
But for many legacy purposes and for content management systems, being able
to handle large sets of data is a very common requirement.
This article shows how to easily send and receive large data files through HTTP with JBoss Fuse using streams.
The main objective of being able to use streams is to avoid running into out of memory issues.">
  
  <link rel="canonical" href="http://0.0.0.0:4000/posts/handling-large-streams-of-data-through-http-with-jboss-fuse/" />
  <meta property="og:url" content="http://0.0.0.0:4000/posts/handling-large-streams-of-data-through-http-with-jboss-fuse/" />
  <meta name="twitter:url" content="http://0.0.0.0:4000/posts/handling-large-streams-of-data-through-http-with-jboss-fuse/">

  <meta property="og:site_name" content="Alain's Tech Blog" />
  <meta property="og:image" content="http://0.0.0.0:4000/assets/images//posts/handling-large-streams-of-data-through-http-with-jboss-fuse/top.jpg" />
  <meta name="twitter:image" content="http://0.0.0.0:4000/assets/images//posts/handling-large-streams-of-data-through-http-with-jboss-fuse/top.jpg">

   <!-- if it's an article -->
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2017-02-13T14:00:00+07:00" />
  <meta property="article:modified_time" content="2017-02-13T14:00:00+07:00" />

  <meta content="http://www.linkedin.com/in/alainpham" property="article:author">

  
	  
	  <meta content="development" property="article:section">
	  
  

  
	  
	  <meta content="jboss-fuse" property="article:tag">
	  
	  <meta content="integration" property="article:tag">
	  
	  <meta content="development" property="article:tag">
	  
	  <meta content="data" property="article:tag">
	  
	  <meta content="api" property="article:tag">
	  
	  <meta content="camel" property="article:tag">
	  
  

    <script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Handling Large Streams of Data through HTTP with JBoss Fuse",
"datePublished": "2017-02-13T14:00:00+07:00",
  
"description": "
Service and api platforms are mostly real time oriented and handle small amounts of data that can be easily processed in memory.
But for many legacy purposes and for content management systems, being able
to handle large sets of data is a very common requirement.
This article shows how to easily send and receive large data files through HTTP with JBoss Fuse using streams.
The main objective of being able to use streams is to avoid running into out of memory issues.



",
  
"url": "http://0.0.0.0:4000/posts/handling-large-streams-of-data-through-http-with-jboss-fuse/"}</script>

  

  <link rel="author" href="http://www.linkedin.com/in/alainpham"/>

   <!-- End SEO stuff -->

  <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/assets/css/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="/assets/css/main.css" />
   <link href="/assets/css/syntax.css" rel="stylesheet">

  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/bootstrap.min.js"></script>

</head>

<body>
	<div>
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<button class="navbar-toggle collapsed" type="button"
					data-toggle="collapse" data-target="#navbar-collapse-menu">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/"> <i class="fa fa-barcode"></i>
				</a>
			</div>
			<div id="navbar-collapse-menu" class="collapse navbar-collapse">
				<ul class="nav navbar-nav">

					
						<!-- If has submenues -->
						
						<li class="dropdown">
							<a class="dropdown-toggle"	data-toggle="dropdown" href="#">
								Featured Projects
								<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								
									<li>
										<a href="/projects/microbam">
											
											MicroBam
										</a>
									</li>
								
									<li>
										<a href="/projects/ourlegacy">
											
											OurLegacy
										</a>
									</li>
								
								</ul>
							</li>
						
					
						<!-- If has submenues -->
						
							<li><a href="/">Posts</a></li>
						
					
						<!-- If has submenues -->
						
							<li><a href="/tags">Tags</a></li>
						
					
						<!-- If has submenues -->
						
							<li><a href="/about">About</a></li>
						
					
						<!-- If has submenues -->
						
						<li class="dropdown">
							<a class="dropdown-toggle"	data-toggle="dropdown" href="#">
								Follow me
								<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								
									<li>
										<a href="http://github.com/alainpham">
											
											<i class="fa fa-inverse fa-github fa-2x"></i>
											
											GitHub
										</a>
									</li>
								
									<li>
										<a href="http://www.linkedin.com/in/alainpham">
											
											<i class="fa fa-inverse fa-linkedin-square fa-2x"></i>
											
											LinkedIn
										</a>
									</li>
								
									<li>
										<a href="https://twitter.com/koint">
											
											<i class="fa fa-inverse fa-twitter fa-2x"></i>
											
											Twitter
										</a>
									</li>
								
								</ul>
							</li>
						
					
				</ul>
			</div>
		</div>
	</nav>
		
		<img
			alt="Handling Large Streams of Data through HTTP with JBoss Fuse"
			src="/assets/images//posts/handling-large-streams-of-data-through-http-with-jboss-fuse/top.jpg" class="img-responsive">
		

	<div class="jumbotron  clearfix">

		<h1 class="text-center">Handling Large Streams of Data through HTTP with JBoss Fuse</h1>

	</div>
</div>

	<div class="container">

	
	<p>
		<strong>February 13, 2017</strong> ( last updated : February 13, 2017 )
		<br>
		
			<a class="label label-default" href="/tags/#jboss-fuse">jboss-fuse</a>
		
			<a class="label label-default" href="/tags/#integration">integration</a>
		
			<a class="label label-default" href="/tags/#development">development</a>
		
			<a class="label label-default" href="/tags/#data">data</a>
		
			<a class="label label-default" href="/tags/#api">api</a>
		
			<a class="label label-default" href="/tags/#camel">camel</a>
		
    </p>
	
	<p>
    	<a href="https://github.com/alainpham/large-http-streams" class="btn btn-default">
		    <i class="fa fa-github fa-2x"></i>  https://github.com/alainpham/large-http-streams
			</a>
	</p>
	
	<hr>
	<h1>Abstract</h1>
	

	<p>
Service and api platforms are mostly real time oriented and handle small amounts of data that can be easily processed in memory.
But for many legacy purposes and for content management systems, being able
to handle large sets of data is a very common requirement.
This article shows how to easily send and receive large data files through HTTP with JBoss Fuse using streams.
The main objective of being able to use streams is to avoid running into out of memory issues.
</p>
<!--more-->

<h2>
JBoss Fuse and its streaming capabilities
</h2>

<p>As a beginner at JBoss Fuse (particularly camel), you might have faced a few issues when the content of
 the message body was a stream. If the body needs to be read more than once, it will result in
 an exception at the second read attempt.
 This is obviously because by default a stream can only be read once.
 It can be quite confusing at the beginning but this gives such great flexibility as to how to process the content.
 The customizations for handling stream is powerful and allows advanced tuning.
 As an example, this is what could be done with a stream :
  </p>
  <ul>
  	<li>Load all into memory : this is the most basic thing to do if you want to be able to read the content twice.
  	But it is not possible when the content size is too large.
  	</li>
  	<li>
  	Load the content bloc by bloc to apply processing : this is useful if processing needs to be applied to the content.
  	Note that the content could be of any format here (xml, csv, binary..)
  	</li>
  	<li>Applying routing condition based on the size of the stream : the content could be loaded partially into memory
  	to be routed through a messaging channel (i.e A-MQ).
  	But if the size of content reaches a certain limit it could be written as a file instead
  	to be transfered through a proper file transfer protocol. This would prevent
  	 large content from breaking the message broker.
  	</li>
  </ul>

 <p>

 <h2>Streaming data with camel-jetty, camel-http4 and file components</h2>
<p>Components such as the camel-jetty, the camel-http4 and the file components that we will use here, do not load the entire payload into memory for processing
unless we force it explicitly.
Instead they will set the message body to a stream object (a pointer) that can be passed through the camel route and
be read only needed.
You can find an implementation example using these components here :
<br>
<a href="https://github.com/alainpham/large-http-streams">https://github.com/alainpham/large-http-streams</a>
</p>
<p>
Below is the workflow implemented in the code example. The content of the input file is never loaded entirely into memory.
</p>

<a href="/assets/images//posts/handling-large-streams-of-data-through-http-with-jboss-fuse/process_stream_file_http.png"> <img
	class="center-block img-responsive"
	src="/assets/images//posts/handling-large-streams-of-data-through-http-with-jboss-fuse/process_stream_file_http.png" alt="stream files through http with Fuse"/></a>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;camelContext</span> <span class="na">xmlns=</span><span class="s">"http://camel.apache.org/schema/spring"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;route&gt;</span>
		<span class="nt">&lt;from</span> <span class="na">uri=</span><span class="s">"file:input?include=.*ready&amp;amp;move=done"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;setHeader</span> <span class="na">headerName=</span><span class="s">"CamelHttpMethod"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;constant&gt;</span>PUT<span class="nt">&lt;/constant&gt;</span>
		<span class="nt">&lt;/setHeader&gt;</span>
		<span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"http4:localhost:8123"</span><span class="nt">&gt;&lt;/to&gt;</span>
		<span class="nt">&lt;log</span> <span class="na">message=</span><span class="s">"${body}"</span><span class="nt">&gt;&lt;/log&gt;</span>
	<span class="nt">&lt;/route&gt;</span>
	<span class="nt">&lt;route&gt;</span>
		<span class="nt">&lt;from</span> <span class="na">uri=</span><span class="s">"jetty:http://0.0.0.0:8123?disableStreamCache=true"</span><span class="nt">/&gt;</span>
		<span class="nt">&lt;log</span> <span class="na">message=</span><span class="s">"Handling a stream of class : ${body.class}"</span><span class="nt">&gt;&lt;/log&gt;</span>
		<span class="nt">&lt;log</span> <span class="na">message=</span><span class="s">"${headers}"</span><span class="nt">&gt;&lt;/log&gt;</span>
		<span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"file:out"</span><span class="nt">&gt;&lt;/to&gt;</span>
		<span class="nt">&lt;setBody&gt;</span>
			<span class="nt">&lt;constant&gt;</span>DONE<span class="nt">&lt;/constant&gt;</span>
		<span class="nt">&lt;/setBody&gt;</span>
	<span class="nt">&lt;/route&gt;</span>
<span class="nt">&lt;/camelContext&gt;</span></code></pre></figure>

<p>
We are streaming through the initial file from end to end. In between the streams is a wire-protocol which is HTTP.
In order to verify that we are really streaming and not loading everything
into memory, we can proceed as follows :
</p>
<ul>
<li>Set the heap size of the JVM low at about 500MB and send a 700MB file through</li>
<li>Watch that memory consumption actually stays stable</li>
</ul>

<p>
Otherwise, it will fail with an out of memory exception if at some point we try to convert the body to a String (i.e after the consumer camel-jetty),
Note also that there are some implicit type conversions such as from a File type to an output stream for the camel-http4 component.
</p>
<p>The nice thing with JBoss Fuse is that although the task to handle streams is quite advanced,
the code stays very simple and maintainable compared to custom low level Java Code.
This is thanks to the reusability of the frameworks components and the smart implicit type conversions built into camel.

We could now easily tweak this example to add complex patterns such as stream-parsing XML data (i.e with XTokenizer) and
route chunks towards other processing units. These units may run in multiple threads or engines for parallel processing and become therefore naturally scalable.
</p>

<a href="/assets/images//posts/handling-large-streams-of-data-through-http-with-jboss-fuse/process_stream_xml_http.png"> <img
	class="center-block img-responsive"
	src="/assets/images//posts/handling-large-streams-of-data-through-http-with-jboss-fuse/process_stream_xml_http.png" alt="stream xml files through http"/></a>



	
	<p>Originally published February 13, 2017
    <br> Latest update February 13, 2017</p>

    <p><strong>Related posts :</strong></p>
        <ul>
	    
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  <li>
			      <a href="/posts/quarkus-kafka-camel-servlet-wiring-it-together/">
			        Quarkus, Kafka, Camel Servlet, Wiring it Together
			      </a>
			  </li>
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  <li>
			      <a href="/posts/quarkus-camel-first-impressions-on-a-game-changing-framework/">
			        Quarkus Camel, First Impressions on a Game Changing Framework
			      </a>
			  </li>
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
		
			  
			  
			  <li>
			      <a href="/posts/fuse-data-grid-integration-via-hot-rod-with-persistence-and-indexing-for-advanced-queries/">
			        Fuse Data Grid Integration via Hot Rod with Persistence and Indexing for Advanced Queries
			      </a>
			  </li>
			  
		
			  
			  
			  <li>
			      <a href="/posts/faster-fuse-integration-service-s2i-openshift-deployments/">
			        Faster Fuse Integration Service 2.0 S2I Openshift Deployments
			      </a>
			  </li>
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
		
			  
			  
			  <li>
			      <a href="/posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/">
			        Ansible Automation for Highly Available JBoss Fuse/A-MQ Integration Platform
			      </a>
			  </li>
			  
		
			  
			  
			  
			  
			  
			  
			  <li>
			      <a href="/posts/quickstart-rest-microservice-with-spring-boot/">
			        Quickstart Json RESTful microservice with Spring-Boot
			      </a>
			  </li>
			  
		
			  
			  
			  
			  
			  <li>
			      <a href="/posts/scalable-network-active-mq-brokers-handing-massive-connections/">
			        Scalable Network of Active MQ brokers for handing massive connections
			      </a>
			  </li>
			  
		
		</ul>
	

	
	
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "https://alainpham.github.io/posts/handling-large-streams-of-data-through-http-with-jboss-fuse/";  // Replace PAGE_URL with your page's canonical URL variable
//this.page.identifier = "/posts/handling-large-streams-of-data-through-http-with-jboss-fuse"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//apham.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
	</div>
	<footer class="footer">
	<ul class="footer-links">
		<li><a href="http://github.com/alainpham"> <i
				class="fa fa-inverse fa-github fa-3x"></i></a></li>
		<li><a href="http://www.linkedin.com/in/alainpham"> <i
				class="fa fa-inverse fa-linkedin-square fa-3x"></i></a></li>
		<li><a href="https://twitter.com/koint"> <i
				class="fa fa-inverse fa-twitter fa-3x"></i></a></li>
	</ul>
</footer>
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>

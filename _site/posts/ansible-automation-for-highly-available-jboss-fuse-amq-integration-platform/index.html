<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" >
  <link rel="shortcut icon" type="image/png" href="/icon.png" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@koint">
  <meta name="twitter:creator" content="@koint">

  <!-- SEO stuff -->
  <title>Ansible Automation for Highly Available JBoss Fuse/A-MQ Integration Platform</title>
  <meta property="og:title" content="Ansible Automation for Highly Available JBoss Fuse/A-MQ Integration Platform" />
  <meta name="twitter:title" content="Ansible Automation for Highly Available JBoss Fuse/A-MQ Integration Platform">


  
	  <meta name="description" content="Most integration/service platform projects start small but
need to ensure high availability requirements and be scalable to handle growing workloads.
This article shows how to use Ansible to automatically provision servers with JBoss Fuse and JBoss ActiveMQ instances
to get a highly available service and messaging platform." />
	  <meta property="og:description" content="Most integration/service platform projects start small but
need to ensure high availability requirements and be scalable to handle growing workloads.
This article shows how to use Ansible to automatically provision servers with JBoss Fuse and JBoss ActiveMQ instances
to get a highly available service and messaging platform." />
	  <meta name="twitter:description" content="Most integration/service platform projects start small but
need to ensure high availability requirements and be scalable to handle growing workloads.
This article shows how to use Ansible to automatically provision servers with JBoss Fuse and JBoss ActiveMQ instances
to get a highly available service and messaging platform.">
  
  <link rel="canonical" href="http://0.0.0.0:4000/posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/" />
  <meta property="og:url" content="http://0.0.0.0:4000/posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/" />
  <meta name="twitter:url" content="http://0.0.0.0:4000/posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/">

  <meta property="og:site_name" content="Alain's Tech Blog" />
  <meta property="og:image" content="http://0.0.0.0:4000/assets/images//posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/top.jpg" />
  <meta name="twitter:image" content="http://0.0.0.0:4000/assets/images//posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/top.jpg">

   <!-- if it's an article -->
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2017-02-13T14:00:00+07:00" />
  <meta property="article:modified_time" content="2017-02-13T14:00:00+07:00" />

  <meta content="http://www.linkedin.com/in/alainpham" property="article:author">

  
	  
	  <meta content="automation" property="article:section">
	  
  

  
	  
	  <meta content="jboss-fuse" property="article:tag">
	  
	  <meta content="ansible" property="article:tag">
	  
	  <meta content="automation" property="article:tag">
	  
	  <meta content="integration" property="article:tag">
	  
	  <meta content="ha" property="article:tag">
	  
	  <meta content="scalability" property="article:tag">
	  
  

    <script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Ansible Automation for Highly Available JBoss Fuse/A-MQ Integration Platform",
"datePublished": "2017-02-13T14:00:00+07:00",
  
"description": "Most integration/service platform projects start small but
need to ensure high availability requirements and be scalable to handle growing workloads.
This article shows how to use Ansible to automatically provision servers with JBoss Fuse and JBoss ActiveMQ instances
to get a highly available service and messaging platform.



",
  
"url": "http://0.0.0.0:4000/posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/"}</script>

  

  <link rel="author" href="http://www.linkedin.com/in/alainpham"/>

   <!-- End SEO stuff -->

  <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/assets/css/font-awesome/css/font-awesome.min.css" />
  <link rel="stylesheet" href="/assets/css/main.css" />
   <link href="/assets/css/syntax.css" rel="stylesheet">

  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/bootstrap.min.js"></script>

</head>

<body>
	<div>
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<button class="navbar-toggle collapsed" type="button"
					data-toggle="collapse" data-target="#navbar-collapse-menu">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="/"> <i class="fa fa-barcode"></i>
				</a>
			</div>
			<div id="navbar-collapse-menu" class="collapse navbar-collapse">
				<ul class="nav navbar-nav">

					
						<!-- If has submenues -->
						
						<li class="dropdown">
							<a class="dropdown-toggle"	data-toggle="dropdown" href="#">
								Featured Projects
								<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								
									<li>
										<a href="/projects/microbam">
											
											MicroBam
										</a>
									</li>
								
									<li>
										<a href="/projects/ourlegacy">
											
											OurLegacy
										</a>
									</li>
								
								</ul>
							</li>
						
					
						<!-- If has submenues -->
						
							<li><a href="/">Posts</a></li>
						
					
						<!-- If has submenues -->
						
							<li><a href="/tags">Tags</a></li>
						
					
						<!-- If has submenues -->
						
							<li><a href="/about">About</a></li>
						
					
						<!-- If has submenues -->
						
						<li class="dropdown">
							<a class="dropdown-toggle"	data-toggle="dropdown" href="#">
								Follow me
								<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								
									<li>
										<a href="http://github.com/alainpham">
											
											<i class="fa fa-inverse fa-github fa-2x"></i>
											
											GitHub
										</a>
									</li>
								
									<li>
										<a href="http://www.linkedin.com/in/alainpham">
											
											<i class="fa fa-inverse fa-linkedin-square fa-2x"></i>
											
											LinkedIn
										</a>
									</li>
								
									<li>
										<a href="https://twitter.com/koint">
											
											<i class="fa fa-inverse fa-twitter fa-2x"></i>
											
											Twitter
										</a>
									</li>
								
								</ul>
							</li>
						
					
				</ul>
			</div>
		</div>
	</nav>
		
		<img
			alt="Ansible Automation for Highly Available JBoss Fuse/A-MQ Integration Platform"
			src="/assets/images//posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/top.jpg" class="img-responsive">
		

	<div class="jumbotron  clearfix">

		<h1 class="text-center">Ansible Automation for Highly Available JBoss Fuse/A-MQ Integration Platform</h1>

	</div>
</div>

	<div class="container">

	
	<p>
		<strong>February 13, 2017</strong> ( last updated : February 13, 2017 )
		<br>
		
			<a class="label label-default" href="/tags/#jboss-fuse">jboss-fuse</a>
		
			<a class="label label-default" href="/tags/#ansible">ansible</a>
		
			<a class="label label-default" href="/tags/#automation">automation</a>
		
			<a class="label label-default" href="/tags/#integration">integration</a>
		
			<a class="label label-default" href="/tags/#ha">ha</a>
		
			<a class="label label-default" href="/tags/#scalability">scalability</a>
		
    </p>
	
	<p>
    	<a href="https://github.com/alainpham/ansible-role-jboss-fuse-amq-ha" class="btn btn-default">
		    <i class="fa fa-github fa-2x"></i>  https://github.com/alainpham/ansible-role-jboss-fuse-amq-ha
			</a>
	</p>
	
	<hr>
	<h1>Abstract</h1>
	

	<p>Most integration/service platform projects start small but
need to ensure high availability requirements and be scalable to handle growing workloads.
This article shows how to use Ansible to automatically provision servers with JBoss Fuse and JBoss ActiveMQ instances
to get a highly available service and messaging platform.
</p>
<!--more-->

<h2>
Minimal Highly Available Architecture
</h2>

<p>
What does a new born reliable Integration Platform look like?
It needs at least 4 machines and a shared storage (NFSV4 or GFS2) as described in the following paragraphs.
</p>


<a href="/assets/images//posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/minimal-fuse-amq-ha.png"> <img
	class="center-block img-responsive"
	src="/assets/images//posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/minimal-fuse-amq-ha.png" alt="minimal high availability Fuse Amq architecture"/></a>


<h3>
  Two machines with JBoss Fuse
</h3>
Here we will run 2 active instances of JBoss Fuse.
We will deploy our services on both machines to get high availablity and also load balancing.
<h3>
  Two machines with JBoss A-MQ
</h3>
  <p>Here we will run 2 couples of failover configured A-MQ instances.
  We link them together in a network of brokers.
  In the nominal case, A-MQ A instance should be active on one machine and A-MQ B instance should be active on the other machine.
  Their failover instances are placed symmetrically on the other machine.
  </p>
  <p>
  This configuration has several advantages :
  </p>
<ul>
 <li>The messaging load is distributed on both machines thus giving a better resource utilization than just having a unique failover configuration</li>
 <li>Shorter downtime when one machine fails can be achieved.

 The failover mechanism takes time to perform since it needs to detect that the lock on
 the store has been released. Disconnected clients can reconnect immediately to the other active instance in the network and render service while
 the failover instance resumes pending messages of the crashed instance.
 </li>
</ul>

<p>
One might argue that dedicating machines to A-MQ is an overkill at the beginning. Why not just put them also on
the same machines as the JBoss Fuse engines?
Well that can be true if messaging is not that highly demanding in our use cases, but limitations will appear quickly when
trying to scale the messaging infrastructure once the platform grows. In fact we would like to be able to scale your messaging
infrastructure independently from the application services hosted on JBoss Fuse instances. In other words, if we do not allocate resources to
A-MQ from the beginning, our new born might be crippled and not be able to grow in the future.
</p>

<h2>
Create an Ansible Role for automation
</h2>

<p>
Ansible is a powerful tool to automate IT infrastructure provisioning, application deployment, configuration management and continuous delivery.
It is an agentless system meaning that we do not have to install anything on the target machines.
The only thing that is needed is a standard ssh access.
</p>

<p>
To get the cluster up and running in little time, I have created an Ansible role that automates the following tasks :

</p>

<ul>
	<li>
		Upload packages to target machines
	</li>
	<li>
	    Setup default users for Fuse/A-MQ
	</li>
	<li>
	    Setup different ports (Hawtio, JMX, ssh, Openwire..) and folders for Fuse/A-MQ
	</li>
	<li>
	    If A-MQ network of brokers is activated, it will configure network connectors from one A-MQ instance to another
	</li>
</ul>
<p>
	<a href="https://github.com/alainpham/ansible-role-jboss-fuse-amq-ha">
	https://github.com/alainpham/ansible-role-jboss-fuse-amq-ha
	</a>
</p>
<p>
Below are the default variables to run the role.
</p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="nn">---</span>
<span class="c1">########################################################</span>
<span class="c1">#This lists all used variables with their sane defaults</span>

<span class="c1">####################################</span>
<span class="c1">#### Generic variables</span>
<span class="c1">####################################</span>
<span class="c1">#path to the Fuse or A-MQ package</span>
<span class="na">src_package_path</span><span class="pi">:</span> <span class="s">./distrib/</span>

<span class="c1">#temporary folder on target host to unzip the package</span>
<span class="na">temp_folder</span><span class="pi">:</span> <span class="s">/home/user/tmp/</span>

<span class="c1">#Fuse or A-MQ package to be installed with version</span>
<span class="na">artifact</span><span class="pi">:</span> <span class="s">jboss-fuse-karaf-6.3.0.redhat-187.zip</span>

<span class="c1">#folder on target host</span>
<span class="na">target_package_folder</span><span class="pi">:</span> <span class="s">/home/user/fuse</span>

<span class="na">karaf_ssh_port</span><span class="pi">:</span> <span class="m">8101</span>
<span class="na">karaf_http_port</span><span class="pi">:</span> <span class="m">8181</span>
<span class="na">rmi_server_port</span><span class="pi">:</span> <span class="m">44444</span>
<span class="na">rmi_registry_port</span><span class="pi">:</span> <span class="m">1099</span>

<span class="c1">#setup default users</span>
<span class="na">users</span><span class="pi">:</span>
  <span class="pi">-</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="na">roles</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">admin</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">admin</span>
  <span class="pi">-</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">guest</span>
    <span class="na">roles</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">viewer</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">guest</span>

<span class="c1">####################################</span>
<span class="c1">#### A-MQ variables</span>
<span class="c1">####################################</span>

<span class="c1">#flag to choose whether to setup a network of A-MQ brokers</span>
<span class="na">setup_amq_network</span><span class="pi">:</span> <span class="s">no</span>

<span class="c1">#########The following variables shoud be redefined in host_vars</span>
<span class="na">amq_broker_name</span><span class="pi">:</span> <span class="s">amq</span>
<span class="na">amq_openwire_port</span><span class="pi">:</span> <span class="m">61616</span>
<span class="na">amq_data_store_folder</span><span class="pi">:</span> <span class="s">${karaf.data}/amq</span>
<span class="c1">#this is an example of the list of target brokers</span>
<span class="na">networked_hosts</span><span class="pi">:</span>
  <span class="pi">-</span>  <span class="na">connect_to_host</span><span class="pi">:</span> <span class="s">amq-b</span>
     <span class="na">master</span><span class="pi">:</span> <span class="s">amq-b-master</span>
     <span class="na">slave</span><span class="pi">:</span> <span class="s">amq-b-slave</span></code></pre></figure>
<p>
In order to run it, we must create a playbook and redefine those variables for Fuse machines and each A-MQ host.
You can find an example play book in the test folder.
</p>

<pre>
├── ansible.cfg
├── distrib                -> folder to put packages in
│   ├── jboss-a-mq-6.3.0.redhat-187.zip
│   ├── jboss-fuse-karaf-6.3.0.redhat-187.zip
│   └── readme.txt
├── group_vars
│   ├── all.yml            -> all the default variables
│   ├── amq.yml            -> all defaults related to A-MQ machines
│   └── fuse.yml           -> all defailts related to Fuse machines
├── host_vars              -> specific configuration to hosts.
│   ├── amq-a-master.yml
│   ├── amq-a-slave.yml
│   ├── amq-b-master.yml
│   └── amq-b-slave.yml
├── inventory
└── playbook.yml
</pre>



<h2>
How to scale up the infrastructure?
</h2>
<p>
So now the question is how do we grow this new born infrastructure?
For JBoss Fuse instances, it is very straightforward, just add machines to the inventory and Ansible will take care of setting up this machine.
</p>
<p>
For Active MQ, we need to think first about the topology of our network. Depending on the use cases this might differ.
I have written a previous post detailing the concentrator topology for IOT purposes. It also explains how to scale down a network of brokers properly.
<br>
<a href="/posts/scalable-network-active-mq-brokers-handing-massive-connections/">
Scalable Network of Active MQ brokers for handing massive connections
</a>
</p>

<p>
If you need your integration platform to grow larger and be highly elastic, consider using PaaS solutions such as
Openshift. I would say that as a general rule of thumb if you exceed 5 machines in your integration cluster,
it can already be interesting to consider the Openshift iPaaS approach.
</p>


<h2>
What next?
</h2>
<p>You can learn the basics about Ansible go to <a href="https://www.ansible.com/get-started">https://www.ansible.com/get-started</a>.
<br>
At some point you might want to scale down your integration platform, you can go ahead and make an Ansible role to automate down scaling.
Furthermore you could write Ansible scripts to automate application deployments to Fuse containers.
</p>



	
	<p>Originally published February 13, 2017
    <br> Latest update February 13, 2017</p>

    <p><strong>Related posts :</strong></p>
        <ul>
	    
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
		
			  
			  
			  <li>
			      <a href="/posts/fuse-data-grid-integration-via-hot-rod-with-persistence-and-indexing-for-advanced-queries/">
			        Fuse Data Grid Integration via Hot Rod with Persistence and Indexing for Advanced Queries
			      </a>
			  </li>
			  
		
			  
			  
			  <li>
			      <a href="/posts/faster-fuse-integration-service-s2i-openshift-deployments/">
			        Faster Fuse Integration Service 2.0 S2I Openshift Deployments
			      </a>
			  </li>
			  
		
			  
			  
			  <li>
			      <a href="/posts/handling-large-streams-of-data-through-http-with-jboss-fuse/">
			        Handling Large Streams of Data through HTTP with JBoss Fuse
			      </a>
			  </li>
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
			  
		
			  
			  
			  
			  
			  
			  
			  
			  
			  <li>
			      <a href="/posts/scalable-network-active-mq-brokers-handing-massive-connections/">
			        Scalable Network of Active MQ brokers for handing massive connections
			      </a>
			  </li>
			  
		
		</ul>
	

	
	
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "https://alainpham.github.io/posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform/";  // Replace PAGE_URL with your page's canonical URL variable
//this.page.identifier = "/posts/ansible-automation-for-highly-available-jboss-fuse-amq-integration-platform"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//apham.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
	</div>
	<footer class="footer">
	<ul class="footer-links">
		<li><a href="http://github.com/alainpham"> <i
				class="fa fa-inverse fa-github fa-3x"></i></a></li>
		<li><a href="http://www.linkedin.com/in/alainpham"> <i
				class="fa fa-inverse fa-linkedin-square fa-3x"></i></a></li>
		<li><a href="https://twitter.com/koint"> <i
				class="fa fa-inverse fa-twitter fa-3x"></i></a></li>
	</ul>
</footer>
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
